import re
import json
import requests
from statistics import mean

API_URL = "http://localhost:8081/generate"  # эндпоинт твоего FastAPI
MODEL_RUNS = 3  # количество прогонов для усреднения
MAX_REQUESTS = 10  # максимальное количество запросов к модели


CLARIFY_QUESTIONS = {
    "1": "Не могли ли вы заснуть или спали плохо?",
    "2": "Было ли такое, что вы не хотели есть или ели слишком много?",
    "3": "Были ли резкие перепады настроения без причины?",
    "4": "Не могли ли вы сдержать своё волнение?",
    "5": "Было ли трудно усидеть на месте из-за нехватки времени?",
    "6": "Есть ли среди ваших заданий особенно сложные или непонятные?",
    "7": "Кажется ли вам, что вокруг вас одни гении?",
    "8": "Есть ли у вас другие проблемы, о которых хотите рассказать?"
}

BASE_PROMPT = """Ты — аналитическая языковая модель. Оцени текст пользователя по 8 вопросам:

1. Ты не мог заснуть после тяжёлого учебного дня или просыпался среди ночи?
2. Бывало ли такое, что тебе излишне долго не хотелось есть или наоборот ел всё подряд?
3. Были ли у тебя резкие перепады настроения?
4. Было ли такое, что ты не мог сдержать своё волнение?
5. Было ли тебе тяжело усидеть на одном месте из-за постоянной нехватки времени?
6. Есть ли среди твоих заданий особенно сложные или непонятные?
7. Кажется ли тебе, что вокруг тебя одни гении?
8. Есть ли у тебя другие проблемы?

Шкала:
0 — нет, никогда
1 — скорее нет
2 — скорее да
3 — да, почти всегда
-1 — недостаточно данных

Текст пользователя:
{user_text}

Выводи только JSON с ключами "1".."8" и значениями 0–3 или -1. Без слов и пояснений.
"""




CLARIFY_PROMPT_TEMPLATE = """Ты — аналитическая языковая модель. Твоя задача — заполнить недостающие ответы на вопросы опросника.

Текст пользователя:
{user_text}

Известные ответы:
{known_answers}

Нужные ответы для уточнения:
{missing_questions}

Ответи только на недостающие вопросы в формате JSON, не меняя известные ответы.
"""

def parse_json_from_text(text):
    match = re.search(r"\{[^{}]+\}", text, re.DOTALL)
    if match:
        try:
            return {k: float(v) for k, v in re.findall(r'"?(\d)"?\s*:\s*(-?\d+\.?\d*)', match.group(0))}
        except:
            return {str(i): -1 for i in range(1, 9)}
    return {str(i): -1 for i in range(1, 9)}

def call_model(user_text):
    prompt = BASE_PROMPT.format(user_text=user_text)
    try:
        resp = requests.post(API_URL, json={"prompt": prompt})
        resp.raise_for_status()
        raw = resp.json().get("response", "")
    except:
        return {str(i): -1 for i in range(1, 9)}

    return parse_json_from_text(raw)

if __name__ == "__main__":
    user_input = input("Введите текст пользователя:\n")
    result = call_model(user_input)
    print("\nИтоговый словарь:")
    print(result)

