version: "3.9"


services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: mireya_api_dev
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      YC_API_TOKEN: ${YC_API_TOKEN}
      ADMINS: ${ADMINS}
    volumes:
      - ./api:/app/api
      - ./helpers:/app/helpers
      - ./llm_service:/app/llm_service
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - mireya_network

  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    container_name: mireya_bot_dev
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    env_file:
      - .env
    environment:
      BOT_TOKEN: ${BOT_TOKEN}
      WEBHOOK_URL: ${WEBHOOK_URL}
      WEBHOOK_PATH: ${WEBHOOK_PATH}
      ADMINS: ${ADMINS}
      YC_API_TOKEN: ${YC_API_TOKEN}
      API_URL: http://api:8000/api
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
    volumes:
      - ./bot:/app/bot
      - ./helpers:/app/helpers
      - ./llm_service:/app/llm_service
    command: python3 -m bot.main
    networks:
      - mireya_network

networks:
  mireya_network:
    driver: bridge


